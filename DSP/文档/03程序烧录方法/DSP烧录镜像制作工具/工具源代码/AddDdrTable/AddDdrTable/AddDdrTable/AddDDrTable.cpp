/********************************************************************************************
 * FILE PURPOSE:Add DDR configuration table after
 ********************************************************************************************
 * FILE NAME: AddDdrTable.c
 *
 * DESCRIPTION: add DDR configuation table on generated .btbl file by hex6x.exe 
 *
 *  usage: Add DDR configuation table right behind entry point(after first 4 bytes)
 *
 ********************************************************************************************/
#include <stdio.h>
#include <malloc.h>
#define MAX_LINE_SIZE 100000
char input[MAX_LINE_SIZE][100];
FILE *fin,*fout;
int i = 0;

#define TMS320C6670
//#define TMS320C6678


#ifdef TMS320C6678
const unsigned char ddrtable[120]={
                           0x00, 0x00, 0x00, 0x70, 0x00, 0x87, 0x35, 0x00, 0x02, 0x42, 0x80, 0xF5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x02,
                           0x63, 0x06, 0x2A, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x50, 0x11, 0x13, 0x78, 0x3C, 0x30, 0x71, 0x7F, 0xE3, 0x55, 0x9F, 0x86, 0xAF,
                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                           0x00, 0x00, 0x00, 0x00, 0x70, 0x07, 0x32, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x05
                         };
#endif

#ifdef TMS320C6670
const unsigned char ddrtable[120]={
	0x00, 0x00, 0x00, 0x70, 0x00, 0x8F, 0x35, 0x00, 0x02, 0x42, 0x80, 0xF5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x02,
	0x63, 0x06, 0x2A, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x50, 0x11, 0x13, 0x78, 0x3C, 0x30, 0x71, 0x7F, 0xE3, 0x55, 0x9F, 0x86, 0xAF,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x70, 0x07, 0x32, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x05
};
#endif



void AddDdrTable()
{
    for(int m=0;m<20;m++)
	{
		fprintf(fout,"%.2X ",ddrtable[m]);
	}
	fprintf(fout,"\n");
	for(int m=20;m<44;m++)
	{
		fprintf(fout,"%.2X ",ddrtable[m]);
	}
	fprintf(fout,"\n");
	for(int m=44;m<68;m++)
	{
		fprintf(fout,"%.2X ",ddrtable[m]);
	}
	fprintf(fout,"\n");
	for(int m=68;m<92;m++)
	{
		fprintf(fout,"%.2X ",ddrtable[m]);
	}
	fprintf(fout,"\n");
	for(int m=92;m<116;m++)
	{
		fprintf(fout,"%.2X ",ddrtable[m]);
	}
	fprintf(fout,"\n");
	for(int m=116;m<120;m++)
	{
	    fprintf(fout,"%.2X ",ddrtable[m]);
	}

}




int main (int argc, char *argv[])
{
	fin =  fopen(argv[1],"rt");
	//read the whole btbl file
	while(1)
	{
		fgets(input[i],100,fin);
		i++;
		if(feof(fin))
		{
			fclose(fin);
			break;
		}
	}

	//start to write the new btbl file
	int k;
	fout = fopen(argv[1],"wt");
	for(int j=0;j<i;j++)
	{
	    k = 0; 
		if(j == i-1)//end of the file
		{
	        fprintf(fout,"%c",input[j][k]);
			fclose(fout);
			return 0;
		}
		while(1)
		{
			if(input[j][k] == 0x0a) //end of a line
			{
				fprintf(fout,"\n");
				break;
			}

			fprintf(fout,"%c",input[j][k]);	
               
			//check whether to add ddr table now or not
			if(j==2 && k == 11)
			{
				AddDdrTable();
			}

			k++;
		}
	}


}
    









    





